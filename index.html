<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
    <title>LIFF Share Target Picker</title>
</head>
<body>
    <h1>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ä‡∏£‡πå...</h1>
    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡∏Ç‡∏∂‡πâ‡∏ô ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô</p>
    <p id="debug-info" style="color: red; font-weight: bold;"></p>
    
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  const LIFF_ID = "1657584857-p5EZEl5O";

  // ‡∏≠‡πà‡∏≤‡∏ô query string (‡∏£‡∏ß‡∏°‡∏Å‡∏£‡∏ì‡∏µ liff.state ‡∏î‡πâ‡∏ß‡∏¢)
  function getQueryParams() {
    var params = {};
    var query = window.location.search.substring(1);

    // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö liff.state=?orderId=...&name=...
    var liffStateMatch = query.match(/liff\.state=([^&]*)/);
    if (liffStateMatch) {
      var liffStateQuery = decodeURIComponent(liffStateMatch[1]);
      if (liffStateQuery.startsWith('?')) {
        query += '&' + liffStateQuery.substring(1);
      }
    }

    var vars = query.split('&');
    for (var i = 0; i < vars.length; i++) {
      var pair = vars[i].split('=');
      if (pair[0] && pair[1]) {
        params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
      }
    }
    return params;
  }

  async function main() {
    const debugEl = document.getElementById('debug-info');

    try {
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isInClient()) {
        debugEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô';
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE');
        return;
      }

      if (!liff.isApiAvailable('shareTargetPicker')) {
        debugEl.textContent = 'LINE ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö shareTargetPicker';
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏≠‡∏õ LINE ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
        return;
      }

      const params = getQueryParams();
      const orderId    = params.orderId     || '-';
      const name       = params.name        || '-';
      const packageName= params.packageName || '-';
      const price      = params.price       || '-';
      const folderUrl  = params.folderUrl   || 'https://lin.ee/4SFfzp3';

      debugEl.textContent =
        `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏ä‡∏£‡πå Order ID: ${orderId} ‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...`;

      const customerShareFlex = {
        type: "flex",
        altText: "üéÅ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + name,
        contents: {
          type: "bubble",
          size: "mega",
          body: {
            type: "box",
            layout: "vertical",
            contents: [
              {
                type: "text",
                text: "üôè ‡∏Ç‡∏≠‡∏ö‡∏û‡∏£‡∏∞‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö ü•∞",
                weight: "bold",
                size: "xl",
                color: "#2E7D32"
              },
              { type: "separator", margin: "md" },
              {
                type: "text",
                text: "Order ID: " + orderId,
                size: "sm",
                wrap: true
              },
              {
                type: "text",
                text: "‡∏Ñ‡∏∏‡∏ì: " + name,
                size: "sm",
                wrap: true
              },
              {
                type: "text",
                text: "‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à: " + packageName,
                size: "sm",
                wrap: true
              },
              {
                type: "text",
                text: "‡∏£‡∏≤‡∏Ñ‡∏≤: " + price + " ‡∏ö‡∏≤‡∏ó",
                weight: "bold",
                size: "md",
                color: "#DB0000"
                wrap: true
              },
              { type: "separator", margin: "md" },
              {
                type: "text",
                text: "‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö",
                size: "md",
                wrap: true,
                margin: "md"
              }
            ]
          },
          footer: {
            type: "box",
            layout: "vertical",
            spacing: "sm",
            contents: [
              {
                type: "button",
                style: "primary",
                color: "#2E7D32",
                action: {
                  type: "uri",
                  label: "üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå",
                  uri: folderUrl
                }
              }
            ]
          }
        }
      };

      await liff.shareTargetPicker([customerShareFlex]);
      debugEl.textContent = '‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚úÖ';
      liff.closeWindow();

    } catch (error) {
      console.error(error);
      debugEl.textContent = '‚ùå Error: ' + error.message;
      alert('‚ùå Error: ' + error.message);
      try { liff.closeWindow(); } catch(e) {}
    }
  }

  main();
</script>
</body>
</html>
