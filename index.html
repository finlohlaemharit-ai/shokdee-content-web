<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
    <title>LIFF Share Target Picker</title>
</head>
<body>
    <h1>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ä‡∏£‡πå...</h1>
    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡∏Ç‡∏∂‡πâ‡∏ô ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô</p>
    <p id="debug-info" style="color: red; font-weight: bold;"></p>
    
    <script src="https://static.line-scdn.net/liff/edge/versions/2.5.0/sdk.js"></script>

    <script>
        // ‚≠ê 1. CONFIG
        const LIFF_ID = "1657584857-p5EZEl5O";
        // *** 2. ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô Deployment URL ‡∏Ç‡∏≠‡∏á GAS Web App ‡∏ó‡∏µ‡πà‡∏°‡∏µ handleGetOrderInfo_ ***
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxcXTO3N54Jhb2kANIiXQ_CltYSjV9YulPz1c9kH_mWajzUQVjVQrwcunBqu4oB9X62/exec'; 

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏¢‡∏Å Query Parameter ‡∏à‡∏≤‡∏Å URL
       // ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå index.html ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        function getQueryParams() {
            var params = {};
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Query String ‡∏´‡∏•‡∏±‡∏Å
            var query = window.location.search.substring(1); 
    
    // ‚≠ê NEW: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å liff.state
            var liffStateMatch = query.match(/liff\.state=([^&]*)/);
                if (liffStateMatch) {
        // ‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á liff.state (‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡∏ñ‡∏≠‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô ?orderId=...)
            var liffStateQuery = decodeURIComponent(liffStateMatch[1]);
        
        // ‡∏•‡∏ö‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞ ? ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö query string ‡∏´‡∏•‡∏±‡∏Å
            if (liffStateQuery.startsWith('?')) {
                query += '&' + liffStateQuery.substring(1);
                }
            }

    // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• Query String ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ Key ‡πÅ‡∏•‡∏∞ Value
            if (pair[0] && pair[1]) { 
                params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
                }
            }
        return params;
        }

// ... ‡∏™‡πà‡∏ß‡∏ô main() ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏ä‡πâ var params = getQueryParams(); ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°

        async function main() {
            let orderId = '';
            try {
                // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Initialize) LIFF
                await liff.init({ liffId: LIFF_ID });

                // 2. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Order ID ‡∏à‡∏≤‡∏Å URL (‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏´‡∏•‡∏±‡∏Å)
                var params = getQueryParams();
                orderId = params.orderId || '';

                if (!orderId) {
                    alert('Error: ‡πÑ‡∏°‡πà‡∏û‡∏ö Order ID ‡πÉ‡∏ô URL');
                    liff.closeWindow();
                    return;
                }
                
                document.getElementById('debug-info').innerText = `Order ID ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ: ${orderId} ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Server...`;

                // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å GAS Server ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                const fetchUrl = `${GAS_WEB_APP_URL}?action=getOrderInfo&orderId=${orderId}`;
                // ‡πÉ‡∏ô function main() ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå index.html
                const response = await fetch(fetchUrl);

                if (!response.ok) {
                 // ‡∏´‡∏≤‡∏Å HTTP Status code ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 200 (‡πÄ‡∏ä‡πà‡∏ô 404, 500)
                       const errorText = await response.text(); 
                       throw new Error(`GAS API Error: HTTP ${response.status} - ${errorText.substring(0, 50)}...`);
                }

                const info = await response.json(); 

                if (info.error) {
                    throw new Error(info.error);
                }
                if (!info || !info.name || !info.imagesFolderUrl) {
                     throw new Error('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå');
                }
                
                // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å Server
                const name = info.name;
                const folderUrl = info.imagesFolderUrl;
                const safePkg = info.packageName || '-';
                const safePrice = info.price || '-';

                // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message JSON ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤
                const customerShareFlex = {
                    "type": "flex",
                    "altText": "üéÅ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + name,
                    "contents": {
                        "type": "bubble",
                        "size": "mega",
                        "body": {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                { "type": "text", "text": "‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤!", "weight": "bold", "size": "xl", "color": "#2E7D32" },
                                { "type": "separator", "margin": "md" },
                                { "type": "text", "text": "Order ID: " + orderId, "size": "sm", "wrap": true },
                                { "type": "text", "text": "‡∏Ñ‡∏∏‡∏ì: " + name, "size": "sm", "wrap": true },
                                { "type": "text", "text": "‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à: " + safePkg, "size": "sm", "wrap": true },
                                { "type": "text", "text": "‡∏£‡∏≤‡∏Ñ‡∏≤: " + safePrice + " ‡∏ö‡∏≤‡∏ó", "size": "sm", "wrap": true },
                                { "type": "separator", "margin": "md" },
                                { "type": "text", "text": "‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞", "size": "md", "wrap": true, "margin": "md" }
                            ]
                        },
                        "footer": {
                            "type": "box",
                            "layout": "vertical",
                            "spacing": "sm",
                            "contents": [
                                {
                                    "type": "button",
                                    "style": "primary",
                                    "color": "#2E7D32",
                                    "action": {
                                        "type": "uri",
                                        "label": "üì• ‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û/‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠",
                                        "uri": folderUrl
                                    }
                                }
                            ]
                        }
                    }
                };

                // 5. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Share Target Picker ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö
                document.getElementById('debug-info').innerText = `‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ä‡∏£‡πå...`;
                await liff.shareTargetPicker([customerShareFlex]);

                // 6. ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á LIFF
                liff.closeWindow();
            } catch (error) {
                console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á LIFF:", error);
                document.getElementById('debug-info').innerText = `‚ùå Error: ${error.message}`;
                alert(`‚ùå Error: ${error.message}`);
                liff.closeWindow();
            }
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        main();
    </script>
</body>
</html>
