<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
    <title>LIFF Share Customer Flex</title>
</head>
<body>
    <h1>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ä‡∏£‡πå...</h1>
    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
    <p id="debug-info" style="color: red; font-weight: bold;"></p>
    
    <script src="https://static.line-scdn.net/liff/edge/versions/2.5.0/sdk.js"></script>

    <script>
        // *** 1. ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô Deployment URL ‡∏Ç‡∏≠‡∏á GAS Web App ‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ***
        // (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö SCRIPT_URL ‡πÉ‡∏ô GAS: https://script.google.com/macros/s/AKfycbzw-BwFE-x8dEZISByHhs_cXnfylkZj14Xfbv0_kETUsIT2Zv4l0G3j3OOrZ0Lo2V1VPw/exec)
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzw-BwFE-x8dEZISByHhs_cXnfylkZj14Xfbv0_kETUsIT2Zv4l0G3j3OOrZ0Lo2V1VPw/exec';
        
        // 2. LIFF ID (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏õ‡∏∏‡πà‡∏° "‡πÅ‡∏ä‡∏£‡πå‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤")
        const LIFF_ID = "1657584857-p5EZEl5O";

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏¢‡∏Å Query Parameter ‡∏à‡∏≤‡∏Å URL
        function getQueryParams() {
            var params = {};
            var query = window.location.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
            }
            return params;
        }

        async function main() {
            let orderId = '';
            try {
                // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF
                await liff.init({ liffId: LIFF_ID });

                // 2. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ orderId ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡πÉ‡∏ô URL ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                var params = getQueryParams();
                orderId = params.orderId || '';

                document.getElementById('debug-info').innerText = `Order ID ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ: ${orderId}`;
                
                if (!orderId) {
                    alert('Error: ‡πÑ‡∏°‡πà‡∏û‡∏ö Order ID ‡πÉ‡∏ô URL');
                    liff.closeWindow();
                    return;
                }

                // 3. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å GAS Web App (Server-Side)
                const fetchUrl = `${GAS_WEB_APP_URL}?action=getOrderInfo&orderId=${orderId}`;
                document.getElementById('debug-info').innerText = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Server...`;

                const response = await fetch(fetchUrl);
                const info = await response.json(); // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó

                if (info.error) {
                    throw new Error(info.error);
                }
                if (!info || !info.name || !info.imagesFolderUrl) {
                     throw new Error('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå');
                }
                
                // *** ‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Server ‡∏°‡∏≤‡πÉ‡∏ä‡πâ ***
                var name = info.name;
                var folderUrl = info.imagesFolderUrl;
                var safePkg = info.packageName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                var safePrice = info.price || '-';
                
                // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message JSON ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'
                var customerShareFlex = {
                    "type": "flex",
                    "altText": "üéÅ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + name,
                    "contents": {
                        "type": "bubble",
                        "size": "mega",
                        "body": {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                { "type": "text", "text": "‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤!", "weight": "bold", "size": "xl", "color": "#2E7D32" },
                                { "type": "separator", "margin": "md" },
                                { "type": "text", "text": "Order ID: " + orderId, "size": "sm", "wrap": true },
                                { "type": "text", "text": "‡∏Ñ‡∏∏‡∏ì: " + name, "size": "sm", "wrap": true },
                                { "type": "text", "text": "‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à: " + safePkg, "size": "sm", "wrap": true },
                                { "type": "text", "text": "‡∏£‡∏≤‡∏Ñ‡∏≤: " + safePrice + " ‡∏ö‡∏≤‡∏ó", "size": "sm", "wrap": true },
                                { "type": "separator", "margin": "md" },
                                { "type": "text", "text": "‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞", "size": "md", "wrap": true, "margin": "md" }
                            ]
                        },
                        "footer": {
                            "type": "box",
                            "layout": "vertical",
                            "spacing": "sm",
                            "contents": [
                                {
                                    "type": "button",
                                    "style": "primary",
                                    "color": "#2E7D32",
                                    "action": {
                                        "type": "uri",
                                        "label": "üì• ‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û/‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠",
                                        "uri": folderUrl
                                    }
                                }
                            ]
                        }
                    }
                };

                // 5. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Share Target Picker ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö
                document.getElementById('debug-info').innerText = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ä‡∏£‡πå...`;
                const success = await liff.shareTargetPicker([customerShareFlex]);

                // 6. ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•
                if (success) {
                    alert("‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!");
                } else {
                    alert("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                }
                
            } catch (error) {
                console.error("LIFF/Fetch Error:", error);
                document.getElementById('debug-info').innerText = `Error: ${error.message}. Order ID: ${orderId}`;
                alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: " + error.message);
            }
            
            // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á LIFF ‡πÄ‡∏™‡∏°‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
            liff.closeWindow();
        }

        main();
    </script>
</body>
</html>
